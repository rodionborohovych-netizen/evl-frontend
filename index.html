<!DOCTYPE html>
<html>
<head>
    <title>EVL Response Debugger</title>
    <style>
        body { font-family: monospace; padding: 20px; }
        .error { color: red; font-weight: bold; }
        .success { color: green; font-weight: bold; }
        pre { background: #f5f5f5; padding: 10px; overflow-x: auto; }
        button { padding: 10px 20px; font-size: 16px; cursor: pointer; }
        .section { margin: 20px 0; border: 1px solid #ccc; padding: 15px; }
    </style>
</head>
<body>
    <h1>EVL Backend Response Debugger</h1>
    
    <div class="section">
        <h2>1. Test Backend Connection</h2>
        <button onclick="testBackend()">Test Backend</button>
        <div id="backend-status"></div>
    </div>

    <div class="section">
        <h2>2. Test Analysis Request</h2>
        <input type="text" id="postcode" value="NW6 7SD" placeholder="Postcode" style="width: 200px; padding: 5px;">
        <button onclick="testAnalysis()">Analyze Location</button>
        <div id="analysis-status"></div>
    </div>

    <div class="section">
        <h2>3. Raw Response</h2>
        <pre id="raw-response">No response yet...</pre>
    </div>

    <div class="section">
        <h2>4. Field Check</h2>
        <pre id="field-check">No data yet...</pre>
    </div>

    <script>
        const API_URL = 'https://web-production-e0c85.up.railway.app';

        async function testBackend() {
            const status = document.getElementById('backend-status');
            status.innerHTML = '⏳ Testing...';
            
            try {
                const response = await fetch(`${API_URL}/health`);
                const data = await response.json();
                status.innerHTML = `<span class="success">✅ Backend is running: ${JSON.stringify(data)}</span>`;
            } catch (error) {
                status.innerHTML = `<span class="error">❌ Backend connection failed: ${error.message}</span>`;
            }
        }

        async function testAnalysis() {
            const statusDiv = document.getElementById('analysis-status');
            const rawDiv = document.getElementById('raw-response');
            const fieldDiv = document.getElementById('field-check');
            const postcode = document.getElementById('postcode').value;

            statusDiv.innerHTML = '⏳ Analyzing...';
            rawDiv.textContent = 'Loading...';
            fieldDiv.textContent = 'Loading...';

            try {
                const response = await fetch(`${API_URL}/api/v2/analyze-location`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        location: { postcode: postcode },
                        radius_km: 1,
                        planned_installation: {
                            charger_type: "DC",
                            power_per_plug_kw: 150.0,
                            plugs: 2
                        },
                        financial_params: {
                            energy_cost_per_kwh: 0.20,
                            tariff_per_kwh: 0.50,
                            fixed_costs_per_month: 500.0
                        },
                        options: { include_raw_sources: true }
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                
                // Show raw response
                rawDiv.textContent = JSON.stringify(data, null, 2);
                
                // Check fields that might cause .replace() errors
                let fieldCheck = 'FIELD CHECKS:\n\n';
                
                const fieldsToCheck = [
                    'summary.location.postcode',
                    'verdict',
                    'summary.headline_recommendation',
                    'financials.capex',
                    'financials.annual_revenue'
                ];

                fieldsToCheck.forEach(path => {
                    const value = getNestedValue(data, path);
                    const type = typeof value;
                    const hasReplace = value && typeof value.replace === 'function';
                    
                    fieldCheck += `${path}:\n`;
                    fieldCheck += `  Value: ${JSON.stringify(value)}\n`;
                    fieldCheck += `  Type: ${type}\n`;
                    fieldCheck += `  Has .replace(): ${hasReplace}\n`;
                    fieldCheck += `  Safe to call .replace(): ${hasReplace ? '✅ YES' : '❌ NO'}\n\n`;
                });

                fieldDiv.textContent = fieldCheck;
                statusDiv.innerHTML = `<span class="success">✅ Analysis complete!</span>`;

            } catch (error) {
                statusDiv.innerHTML = `<span class="error">❌ Error: ${error.message}</span>`;
                rawDiv.textContent = `Error: ${error.message}\n\n${error.stack || ''}`;
                fieldDiv.textContent = 'Failed to get data';
            }
        }

        function getNestedValue(obj, path) {
            return path.split('.').reduce((current, prop) => 
                current && current[prop] !== undefined ? current[prop] : undefined, obj);
        }

        // Test on load
        window.onload = () => {
            console.log('EVL Debugger loaded. Click "Test Backend" to start.');
        };
    </script>
</body>
</html>
